<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publier un article</title>
</head>
<body>
    <div id="divDesContributionAjoutees">
        <label>
            Liste des contributions ajoutées
        </label>
        <ul id="listeDesContributionAjoutees">
        </ul>
    </div>
    <div>
        <form>
            <label>Titre de l'article : </label>
            <input type="text" id="titreContribution">
            <input type="file" accept=".pdf" id="fichierContribution" name="fichierContribution">
            <label>Conférence : </label>
            <select id="titreConference"></select>
        </form>
        <button onclick="publierContribution()"> Publier la contribution</button>
    </div>
</body>

<!-- Publie une contribution -->
<script>
    function publierContribution() {

        let contributionObjet = {
            titre: document.getElementById("titreContribution").value,
            idConference: document.getElementById("titreConference").value,
            statut: true,
            date_publication: new Date(),
            notes: []
        }
      
        let fichier = document.getElementById("fichierContribution")
        const formdata = new FormData()
        formdata.append("fichierContribution",fichier.files[0])
        console.log(formdata)
        
        fetch("http://localhost:3002/contributions", {
            method: "POST",
            headers: new Headers({
                'content-type': "application/json",
                "authorization": localStorage.getItem("token")
            }),
            body: JSON.stringify(contributionObjet)
        })
            .then(async (res) => {
                if (res.status == 200) {    
                    alert("contribution créé avec succès")
                    fetch(`http://localhost:3002/contributions/${(await res.json())._id}/upload`, {
                    method : "PUT",
                    headers: new Headers({
                        "authorization": localStorage.getItem("token")
                    }),
                    body: formdata
                }).then((res) =>{
                    if(res.status == 200){
                        console.log("uploaded")
                    } else {
                        console.log("fail")
                    }
                })
                } else {
                    alert("Erreur dans le dépôt")
                }
            })
    }
</script>

<!-- Affiche les conférences disponibles -->
<script>
    let xhr = new XMLHttpRequest();
    xhr.onload = function (res) {
        let liste = document.getElementById("titreConference");
        let mesTitres = JSON.parse(xhr.response)

        mesTitres.forEach(element => {
            let option = document.createElement("option")
            option.text = element.titre;
            option.value = element._id;
            liste.append(option);
        });
    }
    xhr.open("get", "http://localhost:3002/conferences", true);
    xhr.send();
</script>

<!-- Liste les contributions qui ont été ajoutées -->
<script>
    const Http = new XMLHttpRequest();
    const url = 'http://localhost:3002/contributions';
    Http.open("GET", url);
    Http.send();
    Http.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {

            let data = JSON.parse(Http.responseText)
            let ul = document.getElementById("listeDesContributionAjoutees");
            for (let i = 0; i < data.length; i++) {
                let li = document.createElement("li");
                li.appendChild(document.createTextNode(data[i].titre));
                ul.appendChild(li);
            }
        }
    }
</script>
</html>
